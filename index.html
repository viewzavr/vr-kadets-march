<!DOCTYPE html>
<html>
  <script src="//viewlang.ru/viewlang/code/depends/jquery-2.1.4.js"></script>

  <script src="//viewlang.ru/viewlang/code//depends/qmlweb/src/parser.js"></script>
  <script src="//viewlang.ru/viewlang/code//depends/qmlweb/src/process.js"></script>
  <script src="//viewlang.ru/viewlang/code//depends/qmlweb/src/import.js"></script>
  <script src="//viewlang.ru/viewlang/code//depends/qmlweb/src/qtcore.js"></script>

  <script src="//viewlang.ru/viewlang/code//base.js"></script>
<head>
</head>
<body>
  <div id="qmlSpace">
      target space for qml...
  </div>
  <style>
  #qmlSpace {
    width: 100vw !important;
    bottom: 0px !important;
    z-index: 10000;
  }
  .viewlang-canvas {
    width: 100%; height: 100%;
    margin: 0; padding: 0; display: block; left: 0px; top: 0px; position: absolute;
  }
  body { margin: 0; }
  </style>

  <script src="//viewlang.ru/viewlang/code//threejs_driver/init.js"></script>

  <script type="module">

    ///////////////////////////// qmlweb and viewlang
    
    import * as Viewlang from "//viewlang.ru/viewlang/code/embed2/init.js"
    window.qmlEngine = new QMLEngine( document.getElementById( "qmlSpace" ) );
    Viewlang.setup_qmlweb( qmlEngine );
    qmlEngine.loadFile( "//viewlang.ru/viewzavr/qmlweb-ui2/scene.vl" );
    
    ///////////////////////////// viewzavr
    
    import * as Viewzavr from "//viewlang.ru/viewzavr/init.js";

    var vz = Viewzavr.create( {skipRoot: true} );
    window.vz = vz;
    //window.Viewzavr = Viewzavr;
    //qmlEngine.rootObject.vz = vz;
    
    //////////////////////////// library-one

    import setup_library_one from "//viewlang.ru/viewzavr-apps/library-one/init.js";
    setup_library_one(vz).then( function() {
    
    console.log("library one resolved");
    
    //////////////////////////// viewzavr player
    var vzPlayer = { vz: vz }
    vzPlayer.setRoot = function(root) {
      if (vzPlayer.getRoot()) vz.stopSavingTreeToHash( vzPlayer.getRoot() );
      vzPlayer.root = root;
      qmlEngine.rootObject.vzroot = root;
      vz.saveTreeToHash( root,"mvis" );
    }
    vzPlayer.getRoot = function() {
      return vzPlayer.root;
    }
    window.vzPlayer = vzPlayer;
    
    //////////////////////////// load user script
    
    // use this logic if you want to load app files defined in parameter.
    //var userurl = getParameterByName("src");
    //if (!userurl) userurl = "./app.js";
    
    var userurl = "./app.js";
    
    console.log("user script url=",userurl );

    if (userurl) {
      // тут у нас форматирование для загрузки через прокси
      userurl = formatSrc( userurl );
      console.log("reformatted:",userurl );
      
      import( userurl ).then( function(module) {
        if (module.setup) module.setup( vz );

        if (module.create) {
          var root = module.create( vz, {}); // create a root object for scene
          root.module_url = (userurl.indexOf("//") >= 0 ? userurl : import.meta.url.split("#")[0] + userurl); //;

          if (!root) {
            console.error("WARNING: your create function did return empty result! Viewzavr needs object!");
            root = vz.create_obj( {}, {} );
          }
          
          // sync from saved state
          console.log("restoring from hash...");
          root = vz.restoreFromHash( root,"mvis" );
          vzPlayer.setRoot( root );
        }
      })
    }
    else 
    {
      // this is case when no module provided. we can just start viewzavr.
      var root = vz.restoreFromHash("mvis");
      if (!root) root = vz.create_obj( {}, {} );
      vzPlayer.setRoot( root );
    }

    }) // library one

  </script>

</body>
